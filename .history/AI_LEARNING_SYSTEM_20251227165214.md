# AI Learning System Documentation

This document explains how the AI learning system works in the Okwe - Tactical Pebble Game.

---

## üß† Overview

The AI learning system allows the computer opponent to improve over time by analyzing historical game data. Instead of using only pre-programmed logic, the AI learns from actual gameplay patterns to make better decisions.

### Key Features

- **Pattern Recognition**: Extracts winning opening moves and sequences from past games
- **Position Weighting**: Learns which board positions lead to wins
- **Adaptive Strategy**: Adjusts behavior based on win/loss history
- **Difficulty Levels**: Separate learning for easy, medium, and hard AI
- **Fallback System**: Uses standard AI if no learned data is available

---

## üìÅ File Structure

### Backend Files

**ai/AILearningEngine.php**
- Core learning engine that analyzes game data
- Extracts patterns and generates strategy weights
- Saves learned strategies to JSON cache files

**api/train-ai.php**
- API endpoint to trigger AI training
- Returns training statistics and results

**api/ai-stats.php**
- API endpoint to retrieve AI performance stats
- Loads cached learned strategies

### Frontend Files

**ai/LearnedAI.js**
- JavaScript class that uses learned strategies
- Implements intelligent placement and movement
- Falls back to standard AI when needed

**admin-ai-training.php**
- Admin dashboard for training and monitoring AI
- Shows performance statistics for all difficulty levels
- Provides training interface

### Cache Files

**cache/ai_strategy_{difficulty}.json**
- Cached learned strategies for each difficulty
- Auto-generated by training process
- Contains position weights and patterns

---

## üîÑ How It Works

### 1. Data Collection

When AI plays games, move data is automatically stored in the `ai_training_data` table:

```sql
CREATE TABLE `ai_training_data` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `game_session_id` int(11) DEFAULT NULL,
  `difficulty` enum('easy','medium','hard') NOT NULL,
  `board_state` json NOT NULL,
  `move_sequence` json NOT NULL,
  `winner` enum('X','O') DEFAULT NULL,
  `move_count` int(11) DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT current_timestamp(),
  PRIMARY KEY (`id`)
);
```

### 2. Training Process

When you click "Train AI" in the admin dashboard:

1. **AILearningEngine** analyzes all games for that difficulty
2. **Pattern Extraction**:
   - Opening moves from winning games
   - Winning move sequences
   - Defensive blocking patterns
3. **Weight Generation**:
   - Calculates success rate for each board position (0-8)
   - Higher weights for positions that led to wins
4. **Strategy Caching**:
   - Saves results to `cache/ai_strategy_{difficulty}.json`

### 3. AI Decision Making

During gameplay, the LearnedAI makes decisions in this order:

**Placement Phase:**
1. Check for immediate winning moves
2. Check for blocking opponent's winning moves
3. Use learned opening patterns (if available)
4. Use weighted position selection
5. Fallback to standard AI logic

**Movement Phase:**
1. Check for immediate winning moves
2. Check for blocking opponent's winning moves
3. Use learned pattern matching
4. Fallback to standard AI logic

---

## üìä Strategy File Format

The learned strategy is saved as JSON:

```json
{
  "difficulty": "hard",
  "trained_at": "2025-12-27 10:30:45",
  "stats": {
    "total_games": 150,
    "ai_wins": 95,
    "player_wins": 45,
    "draws": 10,
    "win_rate": 63.33,
    "avg_moves": 12.5
  },
  "weights": {
    "position_weights": {
      "0": 1.2,
      "1": 0.8,
      "2": 1.1,
      "3": 0.9,
      "4": 1.8,
      "5": 0.9,
      "6": 1.0,
      "7": 0.7,
      "8": 1.3
    }
  },
  "patterns": {
    "opening_moves": [
      {
        "positions": [4, 0, 8],
        "success_rate": 0.85
      }
    ],
    "winning_sequences": [
      {
        "sequence": [[4], [0, 4], [4, 8]],
        "frequency": 15
      }
    ],
    "defensive_blocks": [],
    "trap_setups": []
  }
}
```

---

## üéØ Usage Guide

### For Administrators

**Accessing the Training Dashboard:**
1. Navigate to `/admin-ai-training.php`
2. Only accessible to user ID 1 (admin)
3. View statistics for all difficulty levels

**Training the AI:**
1. Click "Train AI" button for desired difficulty
2. Wait for training to complete (usually 1-3 seconds)
3. Review training results in the popup modal
4. AI will immediately use the new strategy in future games

**Monitoring Performance:**
- Total games played
- Win/loss/draw counts
- Win rate percentage
- Average moves per game
- Last training timestamp

### For Players

Players don't need to do anything! The AI automatically uses learned strategies when available:

1. Start a new game against AI (any difficulty)
2. If trained, AI uses learned strategy + standard logic
3. If not trained, AI uses only standard logic
4. Learning happens transparently in the background

---

## üîß Integration Details

### In game-engine.js

The LearnedAI is initialized when the game starts:

```javascript
// AI Learning System
let learnedAI = null;
let aiLoaded = false;

async function init() {
  // ... other initialization

  // Initialize learned AI if playing against computer
  if (GAME_MODE && GAME_MODE.startsWith('pvc')) {
    const difficulty = GAME_MODE.split("-")[1];
    learnedAI = new LearnedAI(difficulty);
    aiLoaded = await learnedAI.loadStrategy();

    if (aiLoaded) {
      console.log(`AI using learned strategy for ${difficulty} difficulty`);
    } else {
      console.log(`AI using standard strategy for ${difficulty} difficulty`);
    }
  }
}
```

### AI Placement Logic

```javascript
function computerPlacement() {
  const difficulty = GAME_MODE.split("-")[1];
  let move = -1;

  // Use learned AI if available
  if (aiLoaded && learnedAI) {
    move = learnedAI.getBestPlacement(board, placedCount);
  } else {
    // Fallback to standard AI logic
    // ... standard placement code
  }

  if (move !== -1) {
    handlePlacement(move);
  }
}
```

### AI Movement Logic

```javascript
function computerMovement() {
  const difficulty = GAME_MODE.split("-")[1];
  let fromTo = null;

  // Use learned AI if available
  if (aiLoaded && learnedAI) {
    fromTo = learnedAI.getBestMovement(board, COMPUTER_PLAYER);
  }

  // Fallback to standard AI logic if learned AI didn't return a move
  if (!fromTo) {
    // ... standard movement code
  }

  if (fromTo) {
    selectedFrom = fromTo.from;
    handleMovement(fromTo.to);
  }
}
```

---

## üöÄ Performance Optimization

### Caching Strategy

- Learned strategies are cached as JSON files
- No database queries during gameplay
- Cache invalidates on new training
- Fast load times (~5-10ms)

### Fallback Mechanism

The system gracefully handles errors:
- Missing cache files ‚Üí Use standard AI
- Invalid JSON ‚Üí Use standard AI
- Network errors ‚Üí Use standard AI
- No training data ‚Üí Use standard AI

---

## üìà Training Recommendations

### When to Train

- After every 20-30 AI games
- When win rate seems too high/low
- After updating AI logic
- When releasing new difficulty level

### Best Practices

1. **Initial Training**: Collect at least 50 games before first training
2. **Regular Updates**: Retrain every week or after significant gameplay
3. **Monitor Stats**: Check win rates - aim for 50-70% AI win rate
4. **Balance Difficulty**: Easy should have lower win rate than Hard

### Data Quality

Good training data requires:
- Mix of wins, losses, and draws
- Various opening strategies
- Different player skill levels
- Sufficient sample size (50+ games minimum)

---

## üîí Security Considerations

### Admin Access

Currently restricted to user ID 1. To add more admins:

**Option 1: Multiple Admin IDs**
```php
// In admin-ai-training.php line 17
$adminIds = [1, 5, 10]; // Add admin user IDs
$stmt = $conn->prepare("SELECT id FROM users WHERE id = ? AND id IN (" . implode(',', $adminIds) . ")");
```

**Option 2: Admin Role Column**
Add `is_admin` column to users table and check:
```php
$stmt = $conn->prepare("SELECT id FROM users WHERE id = ? AND is_admin = 1");
```

### File Permissions

Ensure cache directory is writable:
```bash
chmod 755 cache/
chmod 644 cache/ai_strategy_*.json
```

---

## üêõ Troubleshooting

### AI Not Using Learned Strategy

**Check console logs:**
```javascript
// Look for this message in browser console:
"AI using learned strategy for hard difficulty"
// vs
"AI using standard strategy for hard difficulty"
```

**Verify cache file exists:**
```bash
ls -la cache/ai_strategy_*.json
```

**Check API response:**
```bash
curl http://your-domain/api/ai-stats.php?difficulty=hard
```

### Training Fails

**Common issues:**
1. Insufficient data (< 10 games)
2. Cache directory not writable
3. Database connection issues
4. Invalid JSON in ai_training_data

**Debug steps:**
1. Check error logs at `/admin-errors.php`
2. Verify database table exists: `SHOW TABLES LIKE 'ai_training_data';`
3. Check file permissions: `ls -la cache/`
4. Test API directly: Visit `/api/train-ai.php?difficulty=hard`

### Performance Issues

**If AI is too slow:**
- Check cache file size (should be < 100KB)
- Verify LearnedAI.js is loaded before game-engine.js
- Check browser console for JavaScript errors

**If AI is too strong/weak:**
- Adjust position weight multipliers in LearnedAI.js
- Retrain with more diverse game data
- Modify randomness factor (currently 0.8 + 0.4 random)

---

## üìù API Endpoints

### Train AI
```
GET /api/train-ai.php?difficulty={easy|medium|hard}

Response:
{
  "success": true,
  "message": "AI training completed successfully",
  "stats": {
    "total_games": 150,
    "ai_wins": 95,
    "win_rate": 63.33
  },
  "learned_data": {
    "patterns": { ... },
    "weights": { ... }
  }
}
```

### Get AI Stats
```
GET /api/ai-stats.php?difficulty={easy|medium|hard}

Response:
{
  "success": true,
  "stats": {
    "total_games": 150,
    "win_rate": 63.33
  },
  "learned_strategy": {
    "weights": { ... },
    "patterns": { ... }
  }
}
```

---

## üéì Algorithm Details

### Position Weight Calculation

```php
// For each board position (0-8):
$weight = ($ai_wins_from_position / $total_placements_at_position) * 2.0;

// Normalized to 0.5 - 2.0 range
$normalized = max(0.5, min(2.0, $weight));
```

### Pattern Extraction

**Opening Moves:**
- Takes first 3 AI moves from winning games
- Groups by position sequence
- Calculates success rate per pattern

**Winning Sequences:**
- Extracts full move sequence from AI wins
- Identifies common patterns (e.g., center ‚Üí corner ‚Üí edge)
- Ranks by frequency

### Move Selection

**Placement Phase:**
```javascript
// Priority order:
1. Immediate win (100% priority)
2. Block opponent win (100% priority)
3. Learned opening pattern (if first move)
4. Weighted position selection with randomness
```

**Movement Phase:**
```javascript
// Priority order:
1. Winning move (100% priority)
2. Blocking move (100% priority)
3. Pattern-based move (learned)
4. Random strategic move
```

---

## üåü Future Enhancements

Potential improvements to the AI learning system:

1. **Neural Network Integration**: Use TensorFlow.js for deeper learning
2. **Online Learning**: Update strategies in real-time during gameplay
3. **Opponent Modeling**: Learn specific patterns for each player
4. **Multi-Agent Learning**: AI learns from other AI games
5. **Reinforcement Learning**: Reward-based training system
6. **A/B Testing**: Compare learned vs standard AI performance
7. **Explainable AI**: Show why AI made specific moves
8. **Adaptive Difficulty**: Auto-adjust based on player skill

---

## üìö Code References

### Key Classes

- `AILearningEngine` ([ai/AILearningEngine.php](ai/AILearningEngine.php)) - Core learning engine
- `LearnedAI` ([ai/LearnedAI.js](ai/LearnedAI.js:6)) - Client-side AI using learned data

### Key Functions

- `trainAI()` ([admin-ai-training.php](admin-ai-training.php:296)) - Triggers training from UI
- `analyzeWinningPatterns()` ([ai/AILearningEngine.php](ai/AILearningEngine.php:50)) - Extracts patterns
- `getBestPlacement()` ([ai/LearnedAI.js](ai/LearnedAI.js:40)) - Uses learned weights for placement
- `getBestMovement()` ([ai/LearnedAI.js](ai/LearnedAI.js:171)) - Uses patterns for movement

### Important Variables

- `learnedAI` - Instance of LearnedAI class
- `aiLoaded` - Boolean indicating if strategy loaded successfully
- `strategyWeights` - Position weights array [0-8]
- `patterns` - Object containing opening_moves, winning_sequences, etc.

---

## üí° Developer Notes

- The system is fully backward compatible - games work without training
- All AI improvements are opt-in via admin dashboard
- Standard AI logic is preserved as fallback
- No changes required to existing game mechanics
- Cache files are gitignored by default

---

**Version:** 1.0
**Date:** December 27, 2025
**Author:** Claude Code Enhancement
